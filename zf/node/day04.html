<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>day04</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="前端架构师成长计划！！">
    
    <link rel="preload" href="/Growthplan/assets/css/0.styles.dfa40466.css" as="style"><link rel="preload" href="/Growthplan/assets/js/app.a300a8f4.js" as="script"><link rel="preload" href="/Growthplan/assets/js/2.ddf548a0.js" as="script"><link rel="preload" href="/Growthplan/assets/js/12.2a7a700c.js" as="script"><link rel="prefetch" href="/Growthplan/assets/js/10.889ffded.js"><link rel="prefetch" href="/Growthplan/assets/js/11.1dde6390.js"><link rel="prefetch" href="/Growthplan/assets/js/13.86f682a0.js"><link rel="prefetch" href="/Growthplan/assets/js/3.7985bb7f.js"><link rel="prefetch" href="/Growthplan/assets/js/4.ad862490.js"><link rel="prefetch" href="/Growthplan/assets/js/5.44af799e.js"><link rel="prefetch" href="/Growthplan/assets/js/6.46475436.js"><link rel="prefetch" href="/Growthplan/assets/js/7.bba027cc.js"><link rel="prefetch" href="/Growthplan/assets/js/8.212e750a.js"><link rel="prefetch" href="/Growthplan/assets/js/9.21baed9e.js">
    <link rel="stylesheet" href="/Growthplan/assets/css/0.styles.dfa40466.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Growthplan/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Node</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Growthplan/zf/node/day01.html" class="sidebar-link">day01</a></li><li><a href="/Growthplan/zf/node/day02.html" class="sidebar-link">day02</a></li><li><a href="/Growthplan/zf/node/day03.html" class="sidebar-link">Day03</a></li><li><a href="/Growthplan/zf/node/day04.html" aria-current="page" class="active sidebar-link">day04</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_1-commonjs-规范" class="sidebar-link">1.commonjs 规范</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_2-node-中的模块的分类" class="sidebar-link">2.node 中的模块的分类</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_3-require-模块实现" class="sidebar-link">3.require 模块实现</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_4-events-模块实现" class="sidebar-link">4. Events 模块实现</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_5-npm" class="sidebar-link">5. NPM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_5-1-npm-常用命令" class="sidebar-link">5.1 npm 常用命令</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_5-2-package-json-文件" class="sidebar-link">5.2 package.json 文件</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_5-3-package-lock文件" class="sidebar-link">5.3 package-lock文件</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_5-4-依赖方式" class="sidebar-link">5.4 .依赖方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_6-npm-版本管理" class="sidebar-link">6. npm 版本管理</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_7-scripts配置" class="sidebar-link">7. scripts配置</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_8-包的发布" class="sidebar-link">8. 包的发布</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_9-模块查找机制" class="sidebar-link">9. 模块查找机制</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_10-编码" class="sidebar-link">10. 编码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_10-1-进制" class="sidebar-link">10.1 进制</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_10-2-base64" class="sidebar-link">10.2 base64</a></li><li class="sidebar-sub-header"><a href="/Growthplan/zf/node/day04.html#_10-3-buffer" class="sidebar-link">10.3 buffer</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="day04"><a href="#day04" class="header-anchor">#</a> Day04</h1> <blockquote><p>2021.6.21</p></blockquote> <h2 id="_1-commonjs-规范"><a href="#_1-commonjs-规范" class="header-anchor">#</a> 1.commonjs 规范</h2> <ul><li>1.每个 js 文件都是一个模块</li> <li>2.模块的导出 module.exports</li> <li>3.模块的导入 require</li> <li>exports = module.exports = this</li></ul> <p>es6Module “静态”导入, 在编译的时候就可以知道使用了哪些变量, 可以实现 tree-shaking (都是发送 http 请求实现)</p> <p>commonjs 模块 “动态导入”, commonjs 模块是不支持 tree-shaking (读文件同步操作)</p> <h2 id="_2-node-中的模块的分类"><a href="#_2-node-中的模块的分类" class="header-anchor">#</a> 2.node 中的模块的分类</h2> <ul><li>1.核心模块/内置模块 fs http path 不需要安装 引入的时候不需要增加相对路径、绝对路径</li> <li>2.第三方模块需要安装</li> <li>3.自定义模块需要通过绝对路径或者相对路径进行引入</li></ul> <h2 id="_3-require-模块实现"><a href="#_3-require-模块实现" class="header-anchor">#</a> 3.require 模块实现</h2> <p>require 模块的原理就是 1.读取文件 2. 包装函数 ，设置参数 3，默认返回 module.exports 对象</p> <p>实现如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isExsit</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkPath</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filePath<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;path is Empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> resolvePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> extension <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>resolvePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果没找到直接报错</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExsit</span><span class="token punctuation">(</span>resolvePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 有后缀直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>extension<span class="token punctuation">)</span> <span class="token keyword">return</span> resolvePath<span class="token punctuation">;</span>
    <span class="token comment">// 如果添加了 index.js 没有文件，直接报错；如果有就得到目标文件路径</span>
    resolvePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>resolvePath<span class="token punctuation">,</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExsit</span><span class="token punctuation">(</span>resolvePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> resolvePath<span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not found.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加 后缀 js json 找，如果没有就报错</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ext <span class="token operator">=</span> Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExsit</span><span class="token punctuation">(</span>resolvePath <span class="token operator">+</span> ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> resolvePath <span class="token operator">+</span> ext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not found.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Module<span class="token punctuation">.</span>_extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

Module<span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token punctuation">{</span>
  caches<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">isCache</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>caches<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">cache</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>caches<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>caches<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Module<span class="token punctuation">.</span><span class="token function-variable function">_runScripts</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">scripts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> wraps <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;.js&quot;</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(function(exports,module,require,__filename,__dirname){</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scripts<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">})</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> compileFunction <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span> <span class="token comment">// 为了实现一个简写</span>
      <span class="token keyword">let</span> thisValue <span class="token operator">=</span> exports<span class="token punctuation">;</span> <span class="token comment">//  this = exports = module.exports = {}</span>
      <span class="token keyword">let</span> filename <span class="token operator">=</span> module<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
      <span class="token keyword">let</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">compileFunction</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
        thisValue<span class="token punctuation">,</span>
        exports<span class="token punctuation">,</span>
        module<span class="token punctuation">,</span>
        myRequire<span class="token punctuation">,</span>
        filename<span class="token punctuation">,</span>
        dirname
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;.json&quot;</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">ext</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> wraps<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 核心实现思路</span>
<span class="token keyword">function</span> <span class="token function">myRequire</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 得到目标模块的绝对路径</span>
  <span class="token keyword">let</span> resolvePath <span class="token operator">=</span> <span class="token function">checkPath</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建模块实例</span>
  <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>resolvePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是否缓存，进行不同的操作</span>
  <span class="token keyword">let</span> isCached <span class="token operator">=</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">isCache</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isCached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 已经缓存了 直接返回 不用去读取文件</span>
    <span class="token keyword">return</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没缓存</span>
    <span class="token comment">// 加载目标模块</span>
    <span class="token keyword">let</span> scripts <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_load</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用函数包装模块内容 scripts 并执行</span>
    Module<span class="token punctuation">.</span><span class="token function">_runScripts</span><span class="token punctuation">(</span>scripts<span class="token punctuation">)</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Module<span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> myRequire<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br></div></div><p>我们可以发现，node 模块加载是有缓存机制的，多次引用会从缓存中读取。</p> <p>总结：</p> <p>最终用户使用的结果都来自于 module.exports 如果只是改变 exports 引用，不会影响 module.exports 的值，但是给 exports 增添属性 ，是可以修改 module.exports 的值。 注意不要同时使用 exports，和 module.exports，否则会以 module.exports 结果为基准。</p> <h2 id="_4-events-模块实现"><a href="#_4-events-模块实现" class="header-anchor">#</a> 4. Events 模块实现</h2> <p>实际上就是一个发布订阅模式。</p> <p>EventEmitter 的使用方式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
on <span class="token comment">// 监听事件 参数一：事件名称 参数二：回调函数</span>
emit <span class="token comment">// 触发事件 参数一：事件名称，参数 n （2~n） 参数</span>
off <span class="token comment">// 解绑事件 参数一：事件名称 ，参数二：事件处理函数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> events <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    events <span class="token operator">=</span> events <span class="token operator">?</span> events <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    events<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span> <span class="token operator">=</span> events<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> events <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      events<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">off</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> events <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      events <span class="token operator">=</span> events<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>
        events<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fn <span class="token operator">==</span> cb<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">1</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token function-variable function">once</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> once<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> once<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">cry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;手机丢了我超级难受、哭崩！！！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
e<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&quot;女朋友手机丢了&quot;</span><span class="token punctuation">,</span> cry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// e.off(&quot;女朋友手机丢了&quot;, cry);</span>
e<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;女朋友手机丢了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
e<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;女朋友手机丢了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h2 id="_5-npm"><a href="#_5-npm" class="header-anchor">#</a> 5. NPM</h2> <blockquote><p>全称node package manager是世界上最大规模的包管理系统。</p></blockquote> <h3 id="_5-1-npm-常用命令"><a href="#_5-1-npm-常用命令" class="header-anchor">#</a> 5.1 npm 常用命令</h3> <p><strong>npm init</strong> : 初始化 node 项目，生成一个 package.json 文件。</p> <p><strong>npm install</strong>： 根据  package.json 中的模块信息来安装包。</p> <p><strong>npm install xxx --save-dev</strong>：把 XXX 包作为开发依赖安装。简写 <strong>npm install xxx -D</strong></p> <p><strong>npm install xxx --save</strong> : 把 xxx 包作为项目依赖，打包时需要打包。简写 <strong>npm i xxx -S</strong></p> <p><strong>npm install xxx -g</strong> : 全局安装 xxx 包。</p> <p><strong>npm link</strong> : 把本地包链接到全局的 node_global 中，自己开发包时调试时使用。</p> <h3 id="_5-2-package-json-文件"><a href="#_5-2-package-json-文件" class="header-anchor">#</a> 5.2 package.json 文件</h3> <blockquote><p>package.json 文件就是整个 node 应用的描述文件，其中包括众多信息。</p></blockquote> <p>这里只说一下 <code>bin</code> 配置项。</p> <p><code>bin</code> 配置项用来配置模块的命令，以及命令要会自行的文件。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>  <span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;zm&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./main.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;zf-module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./main.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>主要用于自己开发包时候，先执行 npm link 将包链接到全局中（node_global）然后就可以使用 bin 中配置的命令，执行对应的文件。</p> <h3 id="_5-3-package-lock文件"><a href="#_5-3-package-lock文件" class="header-anchor">#</a> 5.3 package-lock文件</h3> <p>他的特点是将包拍平 ,如果版本不同 会各自安装到自己的模块下。自 npm 5 之后所有的依赖包都采用扁平化管理的方式。<code>package-lock.json</code> 的作用是锁定依赖安装结构，保证在任意机器上执行 <code>npm install</code> 都会得到完全相同的 <code>node_modules</code> 结果，因为<code>package-lock.json</code>存储所有安装的包的信息。如果手动更新了<code>package.json</code>文件，执行安装命令会下载对应的新版本，并且会自动更新 lock文件。</p> <h3 id="_5-4-依赖方式"><a href="#_5-4-依赖方式" class="header-anchor">#</a> 5.4 .依赖方式</h3> <p>**dependencies ** : 项目生产依赖。可以使用 <code>npm install -S</code> 或  <code>npm install --save</code>保存到依赖中，当发布到npm 上时 dependencies 下的模块会作为依赖，一起被下载!</p> <p>**devDependencies ** ： 开发依赖。可以使用 <code>npm install -D</code> 或  <code>npm install --save-dev</code>保存到依赖中。 当发布到 npm 上时 devDependencies 下面的模块就不会自动下载了,如果只是单纯的开发项目 dependencies, devDependencies 只有提示的作用!</p> <p>**peerDependencies ** ： 同版本依赖。同等依赖,如果你安装我，那么你最好也安装我对应的依赖，如果未安装会报出警告  <code>bash &quot;peerDependencies&quot;: { &quot;jquery&quot;: &quot;2.2.0&quot; }</code></p> <p>示例</p> <blockquote><p>npm WARN youxuan@1.0.0 requires a peer of jquery@2.2.0 but none is installed. You must install peer dependencies yourself.</p></blockquote> <p>**bundledDependencies ** ： 捆绑依赖。使用<code>npm pack</code> 打包 tgz 时会将捆绑依赖一同打包。</p> <p>**optionalDependencies ** ： 可选依赖。如果发现无法安装或无法找到，不会影响npm的安装。</p> <h2 id="_6-npm-版本管理"><a href="#_6-npm-版本管理" class="header-anchor">#</a> 6. npm 版本管理</h2> <p>npm 采用了semver 规范作为依赖版本管理方案。semver 约定一个包的版本号必须包含 3个数字</p> <p><code>MAJOR.MINOR.PATCH</code> 意思是 <code>主版本号.小版本号.修订版本号</code></p> <ul><li>MAJOR 对应大的版本号迭代，做了不兼容旧版的修改时要更新 MAJOR 版本号</li> <li>MINOR 对应小版本迭代，发生兼容旧版 API 的修改或功能更新时，更新 MINOR 版本号</li> <li>PATCH 对应修订版本号，一般针对修复 BUG 的版本号</li></ul> <p>当我们每次发布包的时候都需要升级版本号</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> version major  <span class="token comment"># 大版本号加 1，其余版本号归 0</span>
<span class="token function">npm</span> version minor  <span class="token comment"># 小版本号加 1，修订号归 0</span>
<span class="token function">npm</span> version patch  <span class="token comment"># 修订号加 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果使用 git 管理项目会自动 <code>git tag</code> 标注版本号</p> <p>来看看版本号的标识含义:</p> <table><thead><tr><th>range</th> <th>含义</th> <th>例</th></tr></thead> <tbody><tr><td><code>^2.2.1</code></td> <td>指定的 MAJOR 版本号下, 所有更新的版本</td> <td>匹配 <code>2.2.3</code>, <code>2.3.0</code>; 不匹配 <code>1.0.3</code>, <code>3.0.1</code></td></tr> <tr><td><code>~2.2.1</code></td> <td>指定 MAJOR.MINOR 版本号下，所有更新的版本</td> <td>匹配 <code>2.2.3</code>, <code>2.2.9</code> ; 不匹配 <code>2.3.0</code>, <code>2.4.5</code></td></tr> <tr><td><code>&gt;=2.1</code></td> <td>版本号大于或等于 <code>2.1.0</code></td> <td>匹配 <code>2.1.2</code>, <code>3.1</code></td></tr> <tr><td><code>&lt;=2.2</code></td> <td>版本号小于或等于 <code>2.2</code></td> <td>匹配 <code>1.0.0</code>, <code>2.2.1</code>, <code>2.2.11</code></td></tr> <tr><td><code>1.0.0 - 2.0.0</code></td> <td>版本号从 1.0.0 (含) 到 2.0.0 (含)</td> <td>匹配 <code>1.0.0</code>, <code>1.3.4</code>, <code>2.0.0</code></td></tr></tbody></table> <p>预发版：</p> <ul><li>alpha(α)：预览版，或者叫内部测试版；一般不向外部发布，会有很多 bug；一般只有测试人员使用。</li> <li>beta(β)：测试版，或者叫公开测试版；这个阶段的版本会一直加入新的功能；在 alpha 版之后推出。</li> <li>rc(release candidate)：最终测试版本；可能成为最终产品的候选版本，如果未出现问题则可发布成为正式版本。</li></ul> <p><code>2.1.0-beta.1</code> 这样声明的版本用户不会立马使用，可以用来做测试使用</p> <h2 id="_7-scripts配置"><a href="#_7-scripts配置" class="header-anchor">#</a> 7. scripts配置</h2> <p>在 package.json 中可以定义自己的脚本通过 <code>npm run</code>来执行</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;hello&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo hello&quot;</span><span class="token punctuation">,</span>
   <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们可以使用 <code>npm run hello</code> 执行脚本,也可以使用 <code>npm run build</code>执行<code>node_modules/.bin</code>目录下的webpack 文件</p> <ul><li><p><code>npm run</code> 命令执行时，会把 <code>./node_modules/.bin/</code> 目录添加到执行环境的 <code>PATH</code> 变量中，因此如果某个<strong>命令行包</strong>未全局安装，而只安装在了当前项目的 node_modules 中，通过 <code>npm run</code> 一样可以调用该命令。</p></li> <li><p>执行 npm 脚本时要传入参数，需要在命令后加 <code>--</code> 标明, 如 <code>npm run hello -- --port 3000</code> 可以将 <code>--port</code> 参数传给<code>hello</code> 命令</p></li> <li><p>npm 提供了 pre 和 post 两种钩子机制，可以定义某个脚本前后的执行脚本,没有定义默认会忽略</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;prehello&quot;</span><span class="token operator">:</span><span class="token string">&quot;echo prehello&quot;</span><span class="token punctuation">,</span>
   <span class="token property">&quot;hello&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo hello&quot;</span><span class="token punctuation">,</span>
   <span class="token property">&quot;posthello&quot;</span><span class="token operator">:</span><span class="token string">&quot;echo posthello&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <p>可以通过打印<code>全局env</code>和 在项目下执行<code>npm run env</code>来对比<code>PATH</code>属性，不难发现在执行npm run 的时候确实会将 <code>./node_modules/.bin/</code> 目录添加到<code>PATH中</code></p> <h2 id="_8-包的发布"><a href="#_8-包的发布" class="header-anchor">#</a> 8. 包的发布</h2> <p>包的发布比较简单，首先我们需要先切换到官方源,这里推荐个好用的工具 nrm</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> nrm -g
nrm use <span class="token function">npm</span> <span class="token comment"># 切换到官方源</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>之后更新名字哈，这里也可以发布 <a href="https://docs.npmjs.com/creating-and-publishing-scoped-public-packages" target="_blank" rel="noopener noreferrer">作用域包<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 选定版本后,忽略文件夹可以使用 <code>.npmignore</code>,一切就绪后，发布！！！</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> publish
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ok，我们的包就可以成功的发布到 npm 上啦~</p> <h2 id="_9-模块查找机制"><a href="#_9-模块查找机制" class="header-anchor">#</a> 9. 模块查找机制</h2> <p>文件模块查找：</p> <p>先添加后缀查找有没有此文件，如果没有文件找同名的目录。如果没有查找 index.js 文件，默认会去找 package.json 对应的入口文件 <code>main</code> 字段，如果没找到直接报错。</p> <p>第三方模块查找：</p> <p>会现在自己的目录下 <code>node_modules</code> 下查找同名的文件夹，找不到向上层查找，到根目录位置，如果都找不到则出错。</p> <h2 id="_10-编码"><a href="#_10-编码" class="header-anchor">#</a> 10. 编码</h2> <h3 id="_10-1-进制"><a href="#_10-1-进制" class="header-anchor">#</a> 10.1 进制</h3> <p><strong>将任何进制转换成10进制</strong> ： 当前位的值 * 当前进制^(所在位-1) 累加的结果。</p> <p><strong>将整数转换成其他进制</strong> ： 需要不停的取余数，取反向输出。</p> <p>2进制以 0b 开头、8进制以0o开头、16进制以0x开头。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'1010'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进制之间的转化 二进制转换为 10 进制</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">10.</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 把 10 进制转为 2 进制</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">255.</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 把 10 进制转为 8 进制</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>问题</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token number">0.1</span> <span class="token operator">+</span><span class="token number">0.2</span> <span class="token operator">!==</span> <span class="token number">0.3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这是为什么？</p> <p>这是因为小数的存储不精确，所以做运算时会有精度损失。</p> <p>接下来我们来探究其原理。</p> <p>小数转为二进制表示使用的算法为： 乘二取整法 。</p> <p>把 0.1 转为  二进制的实现过程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token number">0.1</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0.2</span> <span class="token comment">// 0 [大于 1 就取 1 ，小于 1 就取 0]</span>
<span class="token number">0.2</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0.4</span> <span class="token comment">// 0 [大于 1 就取 1 ，小于 1 就取 0]</span>
<span class="token number">0.4</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0.8</span> <span class="token comment">// 0 [大于 1 就取 1 ，小于 1 就取 0]</span>
<span class="token number">0.8</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1.6</span> <span class="token comment">// 1 [大于 1 就取 1 ，小于 1 就取 0]</span>
<span class="token number">0.6</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1.2</span> <span class="token comment">// 1 [大于 1 就取 1 ，小于 1 就取 0]</span>
<span class="token number">0.2</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0.4</span> <span class="token comment">// 0 [大于 1 就取 1 ，小于 1 就取 0]</span>
<span class="token operator">...</span> <span class="token operator">...</span><span class="token punctuation">.</span> <span class="token operator">...</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到 0.1 的二进制表示就是无限循环的，但是计算机有限的存储空间无法存储无限的数据，所以有精度损失。</p> <p>但是 我们又看看</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token number">0.2</span> <span class="token operator">+</span> <span class="token number">0.2</span> <span class="token operator">===</span> <span class="token number">0.4</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>卧槽这又是为什么？不是表示不精确吗？为什么这里有准确计算了？</p> <p>原因在于，参见这篇文章。<a href="https://zhuanlan.zhihu.com/p/95318421" target="_blank" rel="noopener noreferrer">详解js中0.1+0.2!=0.3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_10-2-base64"><a href="#_10-2-base64" class="header-anchor">#</a> 10.2 base64</h3> <p>base64是一个编码规范。 base64 开发中能替换掉路径，而且可以用于传输，减少网络请求。不能滥用 base64 ，因为它处理的文件后大小会变大。</p> <h3 id="_10-3-buffer"><a href="#_10-3-buffer" class="header-anchor">#</a> 10.3 buffer</h3></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Growthplan/zf/node/day03.html" class="prev">
        Day03
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Growthplan/assets/js/app.a300a8f4.js" defer></script><script src="/Growthplan/assets/js/2.ddf548a0.js" defer></script><script src="/Growthplan/assets/js/12.2a7a700c.js" defer></script>
  </body>
</html>
