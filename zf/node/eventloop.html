<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器 EventLoop</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="前端架构师成长计划！！">
    
    <link rel="preload" href="/Growthplan/assets/css/0.styles.dfa40466.css" as="style"><link rel="preload" href="/Growthplan/assets/js/app.a300a8f4.js" as="script"><link rel="preload" href="/Growthplan/assets/js/2.ddf548a0.js" as="script"><link rel="preload" href="/Growthplan/assets/js/13.86f682a0.js" as="script"><link rel="prefetch" href="/Growthplan/assets/js/10.889ffded.js"><link rel="prefetch" href="/Growthplan/assets/js/11.1dde6390.js"><link rel="prefetch" href="/Growthplan/assets/js/12.2a7a700c.js"><link rel="prefetch" href="/Growthplan/assets/js/3.7985bb7f.js"><link rel="prefetch" href="/Growthplan/assets/js/4.ad862490.js"><link rel="prefetch" href="/Growthplan/assets/js/5.44af799e.js"><link rel="prefetch" href="/Growthplan/assets/js/6.46475436.js"><link rel="prefetch" href="/Growthplan/assets/js/7.bba027cc.js"><link rel="prefetch" href="/Growthplan/assets/js/8.212e750a.js"><link rel="prefetch" href="/Growthplan/assets/js/9.21baed9e.js">
    <link rel="stylesheet" href="/Growthplan/assets/css/0.styles.dfa40466.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Growthplan/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Node</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Growthplan/zf/node/day01.html" class="sidebar-link">day01</a></li><li><a href="/Growthplan/zf/node/day02.html" class="sidebar-link">day02</a></li><li><a href="/Growthplan/zf/node/day03.html" class="sidebar-link">Day03</a></li><li><a href="/Growthplan/zf/node/day04.html" class="sidebar-link">day04</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浏览器事件循环机制"><a href="#浏览器事件循环机制" class="header-anchor">#</a> 浏览器事件循环机制</h1> <h2 id="js是单线程的"><a href="#js是单线程的" class="header-anchor">#</a> JS是单线程的</h2> <p>JS 是单线程的，或者说只有一个主线程，也就是它一次只能执行一段代码。JS 中其实是没有线程概念的，所谓的单线程也只是相对于多线程而言。JS 的设计初衷就没有考虑这些，针对 JS 这种不具备并行任务处理的特性，我们称之为“单线程”。</p> <p>虽然 JS 运行在浏览器中是单线程的，但是浏览器是事件驱动的（Event driven），浏览器中很多行为是异步（Asynchronized）的，会创建事件并放入执行队列中。浏览器中很多异步行为都是由浏览器新开一个线程去完成，一个浏览器至少实现三个常驻线程：</p> <ul><li>JS 引擎线程</li> <li>GUI 渲染线程</li> <li>事件触发线程</li></ul> <h2 id="js引擎"><a href="#js引擎" class="header-anchor">#</a> JS引擎</h2> <p>JavaScript 引擎是一个专门处理 JavaScript 脚本的虚拟机，一般会附带在网页浏览器之中，比如最出名的就是 Chrome 浏览器的 V8 引擎，如下图所示，JS 引擎主要有两个组件构成：</p> <ul><li>堆-内存分配发生的地方</li> <li>栈-函数调用时会形一个个栈帧（frame） <img src="https://user-gold-cdn.xitu.io/2018/5/16/163677dd80f490c4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></li></ul> <h2 id="执行栈"><a href="#执行栈" class="header-anchor">#</a> 执行栈</h2> <p>每一个函数执行的时候，都会生成新的 execution context（执行上下文），执行上下文会包含一些当前函数的参数、局部变量之类的信息，它会被推入栈中， running execution context（正在执行的上下文）始终处于栈的顶部。当函数执行完后，它的执行上下文会从栈弹出。</p> <p><img src="https://user-gold-cdn.xitu.io/2018/5/16/163677dd815e80e6?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"> 举个简单的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>执行过程中栈的变化：</p> <p><img src="https://user-gold-cdn.xitu.io/2018/5/16/163677dd816c8e88?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p> <h2 id="event-loop-事件循环"><a href="#event-loop-事件循环" class="header-anchor">#</a> event loop(事件循环)</h2> <p>Wikipedia这样定义:</p> <blockquote><p>&quot;Event Loop是一个程序结构，用于等待和发送消息和事件。（a programming construct that waits for and dispatches events or messages in a program.）&quot;</p></blockquote> <p><strong>简单说，就是在程序中设置两个线程：一个负责程序本身的运行，称为&quot;主线程&quot;；另一个负责主线程与其他进程（主要是各种I/O操作）的通信，被称为&quot;Event Loop线程&quot;（可以译为&quot;消息线程&quot;）。</strong></p> <p><img src="https://user-gold-cdn.xitu.io/2018/5/16/163677dda920b2af?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p> <h2 id="事件循环与任务队列"><a href="#事件循环与任务队列" class="header-anchor">#</a> 事件循环与任务队列</h2> <p>事件循环可以简单描述为：</p> <ol><li>函数入栈，当 Stack 中执行到异步任务的时候，就将他丢给 WebAPIs, 接着执行同步任务,直到 Stack 为空;</li> <li>在此期间 WebAPIs 完成这个事件，把回调函数放入 CallbackQueue 中等待;</li> <li>当执行栈为空时，Event Loop 把 Callback Queue 中的一个任务放入Stack中,回到第1步。 <img src="https://user-gold-cdn.xitu.io/2018/5/16/163677dd81721ac8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></li></ol> <ul><li><strong>Event Loop 是由 javascript 宿主环境（像浏览器）来实现的;</strong></li> <li>WebAPIs 是由 C++ 实现的浏览器创建的线程，处理诸如 DOM 事件、http 请求、定时器等异步事件;</li> <li>JavaScript 的并发模型基于&quot;事件循环&quot;;</li> <li>Callback Queue(Event Queue 或者 Message Queue) 任务队列,存放异步任务的回调函数</li></ul> <p>接下来看一个异步函数执行的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> start<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;时间间隔：&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token operator">+</span><span class="token string">'ms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol><li>main(Script) 函数入栈, start 变量开始初始化</li> <li>setTimeout 入栈,出栈,丢给 WebAPIs, 开始定时 500ms;</li> <li>while 循环入栈,开始阻塞 1000ms;</li> <li>500ms 过后, WebAPIs 把 cb() 放入任务队列,此时 while 循环还在栈中 ,cb() 等待;</li> <li>又过了 500ms, while 循环执行完毕从栈中弹出, main() 弹出,此时栈为空, Event Loop, cb() 进入栈, log() 进栈,输出'时间间隔：1003ms', 出栈, cb() 出栈</li></ol> <h2 id="宏任务-macrotasks-和微任务-microtasks"><a href="#宏任务-macrotasks-和微任务-microtasks" class="header-anchor">#</a> 宏任务(Macrotasks)和微任务(Microtasks)</h2> <p>其实我们上面所说的都是宏任务 (Macrotasks)，但是js中还有一种队列微任务 (Microtasks)。</p> <p>macro-task(Task): 一个 event loop 有一个或者多个 task 队列。task 任务源非常宽泛，比如 ajax 的 onload，click 事件，基本上我们经常绑定的各种事件都是 task 任务源，还有数据库操作（IndexedDB ），需要注意的是 setTimeout、setInterval、setImmediate 也是task 任务源。总结来说 task 任务源：</p> <ul><li>setTimeout</li> <li>setInterval</li> <li>setImmediate</li> <li>I/O</li> <li>UI rendering</li></ul> <p>micro-task(Job): microtask 队列和 task 队列有些相似，都是先进先出的队列，由指定的任务源去提供任务，不同的是一个 event loop里只有一个 microtask 队列。另外 microtask 执行时机和 Macrotasks 也有所差异</p> <ul><li>process.nextTick</li> <li>promises</li> <li>Object.observe</li> <li>MutationObserver</li></ul> <p>那么 Macrotasks 和 Microtasks 有什么别区别呢
举个简单的例子，假设一个script标签的代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">promise1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">setTimeout1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout1'</span><span class="token punctuation">)</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span>  <span class="token function">promise2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">setTimeout2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>运行过程：</p> <p>script里的代码被列为一个task，放入task队列。</p> <h4 id="循环1"><a href="#循环1" class="header-anchor">#</a> 循环1：</h4> <ul><li>【task队列：script ；microtask队列：】</li></ul> <ol><li>从task队列中取出script任务，推入栈中执行。</li> <li>promise1列为microtask，setTimeout1列为task，setTimeout2列为task。</li></ol> <ul><li>【task队列：setTimeout1 setTimeout2；microtask队列：promise1】</li></ul> <ol><li>script任务执行完毕，执行microtask checkpoint，取出microtask队列的promise1执行。</li></ol> <h4 id="循环2"><a href="#循环2" class="header-anchor">#</a> 循环2：</h4> <p>*【task队列：setTimeout1 setTimeout2；microtask队列：】 4. 从task队列中取出setTimeout1，推入栈中执行，将promise2列为microtask。</p> <ul><li>【task队列：setTimeout2；microtask队列：promise2】</li></ul> <ol><li>执行microtask checkpoint，取出microtask队列的promise2执行。</li></ol> <h4 id="循环3"><a href="#循环3" class="header-anchor">#</a> 循环3：</h4> <ul><li>【task队列：setTimeout2；microtask队列：】</li></ul> <ol><li>从task队列中取出setTimeout2，推入栈中执行。 7.setTimeout2任务执行完毕，执行microtask checkpoint。</li></ol> <ul><li>【task队列：；microtask队列：】</li></ul> <p><img src="https://user-gold-cdn.xitu.io/2018/5/16/163677dd81bee55c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p> <p>综上所说，每次 event loop 循环执行栈完成后，会继续执行完相应的 microtask 任务</p> <h2 id="event-loop中的update-the-rendering-更新渲染"><a href="#event-loop中的update-the-rendering-更新渲染" class="header-anchor">#</a> event loop中的Update the rendering（更新渲染）</h2> <p>这是 event loop 中很重要部分，在第7步会进行 Update the rendering（更新渲染），规范允许浏览器自己选择是否更新视图。也就是说可能不是每轮事件循环都去更新视图，只在有必要的时候才更新视图。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/Growthplan/assets/js/app.a300a8f4.js" defer></script><script src="/Growthplan/assets/js/2.ddf548a0.js" defer></script><script src="/Growthplan/assets/js/13.86f682a0.js" defer></script>
  </body>
</html>
